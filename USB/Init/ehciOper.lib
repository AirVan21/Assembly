initOperationalInfo macro

 	
; =====================================================================================================
; Operational registers offsets


HCSPARAMoffset = 04h 

USBCMDoffset   = 00h
USBSTSoffset   = 04h
USBINToffset   = 08h
FRINDEXoffset  = 0Ch
CTRLDSoffset   = 10h 
PeriodLBoffset = 14h
AsуnchLBoffset = 18h 
CONFIGoffgset  = 40h
PORTSCOffset   = 44h


; =====================================================================================================
; Operational Registers Table 
; 
; [31:24] - reserved; [23:16] - Interrupt interval; [15:12] - reserved; [11] - Asynch Shedule Park; [10] - reserved
; [9:8] - Asynch Shedule Park Mode; [7] - Light HC reset; [6] - Interrupt on Asynch Doorbell; [5] - Async Schedule; [4] - Periodic Schedule;  
; [3:2] - Frame list size; [1] - HC Reset; [0] - Run/Stop bit 
; Default = 00080000h 
USBCMDReg	dw 0h 
; [0] - Complete USB Transation  
USBSTSReg			dw 0h 
USBINTReg			dw 0h 
FRINDEXReg			dw 0h 
CTRLDSSEGMENTReg 	dw 0h
PeriodLBReg			dw 0h 
; [31:5] - Pointer to QH ; [4:0] - zeros (Pointer 32 byte aligned)
AsуnchLBReg			dw 0h
; HC configuration auxiliary use 
CONFIGReg			dw 0h 

; =====================================================================================================

 	; Prints information about HC Operational I/O Registers 
	;
	; EBX - contains BAR address
	; FS  - contains Selector For Zero Memory
	printEHCIOperInfo proc near

		push ebx           		 ; Save 
		push eax           		 ; 
		push edx                 ;
		push edi                 ; 
		;------------------------
		
		mov edi, ebx 			; Save 
		
		; USB CMD
		lea dx, USBCMDmsg       ; Address for Message
		mov ah, 09h             ; Print Function
		int 21h

		mov eax, USBCMDoffset   ; USBCMD 

		call retrieveOperRegister; Prints USB CMD Register 

		call printNewLineRM     ; Prints New Line 

		; USB STS 
		lea dx, USBSTSmsg       ; Address for Message
		mov ah, 09h             ; Print Function
		int 21h

		mov ebx, edi            ; Base Address 
		mov eax, USBSTSoffset   ; USBSTS 

		call retrieveOperRegister ; Print USB STS

		call printNewLineRM     ; Prints New Line 

		;Period List Base 
		
		lea dx, PListBase       ; Address for Message
		mov ah, 09h             ; Print Function
		int 21h

		mov ebx, edi            ;  
		mov eax, PeriodLBoffset ; USBSTS 

		call retrieveOperRegister; Print Period Base
		
		call printNewLineRM     ; Prints New Line 

		; PORTSC Register 
		
		lea dx, PORTSCMsg       ; Address for Message
		mov ah, 09h             ; Print Function
		int 21h

		mov ebx, edi            ; 
		mov eax, PORTSCoffset   ; PORTSC offset 
		
		call retrieveOperRegister; Print Period Base
		
		call printNewLineRM     ; Prints New Line 

		;------------------------
		; Out
		
		pop edi 
		pop edx                  ; 
		pop eax                  ; Recover edi
		pop ebx            		 ; Recover ebx 

		ret 
	
	endp

	; Retieves and prints Operational register (USBCMD, USBSTS) 
	; 
	; EAX - contains offset for certain Register
	; EBX - contains Base Address (BAR)
	retrieveOperRegister proc near
		
		push ebx           		; Save ebx 
		push eax			   	; Save eax
		push ecx                ;

		xor ecx, ecx            ;
		
		add ebx, eax            ; 
		mov cx, OperRegOff      ; Get Offset For Operational Registers 
		add ebx, ecx           	; Add Offset for Operational registers

		mov eax, fs:[ebx]       ; Getting USBCMD
		push ax                 ; Print USBCMD
		shr eax, 16             ;
		push ax              	;
		call printWordFromStackRM
		call printWordFromStackRM
		
		pop ecx                  ; Recover Registers
		pop eax             	;
		pop ebx                 ;
		
		ret
	
	endp

	; Prints information about HC Ports from PORTSC Registers  
	;
	; EBX - contains Base Address 
	printPORTSCinfo proc 

		push ebx           		 ; Save Registers  
		push eax           		 ; 
		push ecx                 ;
		push edi                 ;
		;------------------------;

		mov edi, ebx 			 ; Save Base Address Register
		
		add ebx, HCSPARAMoffset	 ; 
		mov ecx, fs:[ebx]		 ; HCPARAMS Register in ecx 
		and ecx, 000Fh 			 ; Set only N_PORTS Value 
		

		push cx 
		call printWordFromStackRM; 
	  	call printNewLineRM		 ;

		add ecx, 8

		xor eax, eax 			 ;
		mov ax, OperRegOff
		add edi, eax  			 ; Pointer to Operational Registers
		add edi, PORTSCoffset 	 ; 
								 ; Counter = N_PORTS
	  loopOnPORTs:

	  	mov eax, fs:[edi]		 ; PORTSC value 
	  	; Prints Answer
	  	push ax 				 ; 
	  	shr eax, 16              ;
	  	push ax 				 ;
	  	call printWordFromStackRM;
		call printWordFromStackRM; 
	  	call printNewLineRM		 ;
	  	; Moves to the next register
	  	add edi, 04h             ; 32-bit step 

	  	loop loopOnPORTs		 ; Loop 

		;------------------------;
		pop edi 				 ;
		pop ecx                  ; 
		pop eax                  ; Recover edi
		pop ebx            		 ; Recover ebx 

		ret 
	endp

	; Updates information about Operation Registres in memory  
	;
	; EBX - contains Base Address 
	updateOperRegInfo proc
		
		push ebx           		 ; Save Registers  
		push eax           		 ; 
		push ecx                 ;
		push edi                 ;
		;------------------------;

		mov ax, OperRegOff		 ;
		add ebx, eax 			 ; Offset for Operation Registers
		 

		;------------------------;
		pop edi 				 ;
		pop ecx                  ; 
		pop eax                  ; Recover edi
		pop ebx            		 ; Recover ebx 

		ret 
	endp


endm